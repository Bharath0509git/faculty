<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - College of Engineering Guindy</title>
    <style>
      /* Your Existing CSS (no change needed) */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f8f9fa;
        display: flex;
        height: 100vh;
      }

      .sidebar {
        width: 250px;
        height: 100vh;
        background-color: #0f83ff;
        color: white;
        position: fixed;
        top: 0;
        left: 0;
        padding: 20px;
        overflow-y: auto;
        transition: all 0.3s ease;
      }

      .sidebar.collapsed {
        width: 50px;
        padding: 20px;
        color: transparent;
        overflow: hidden;
      }

      .sidebar.collapsed ul,
      .sidebar.collapsed h2 {
        display: none;
      }

      .sidebar h2 {
        text-align: center;
        margin-bottom: 30px;
      }

      .sidebar ul {
        list-style: none;
        padding: 0;
      }

      .sidebar ul li {
        margin: 20px 0;
      }

      .sidebar ul li a {
        color: white;
        text-decoration: none;
        font-size: 18px;
        display: block;
      }

      .sidebar ul li a.active {
        font-weight: bold;
      }

      .content-wrapper {
        margin-left: 250px;
        padding: 20px;
        transition: margin-left 0.3s ease;
        width: 100%;
        max-width: 1200px;
        margin-right: 20px;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .content-wrapper.collapsed {
        margin-left: 50px;
        display: flex;
        justify-content: center;
        width: 100%;
      }

      .content {
        width: 100%;
        max-width: 1200px;
        text-align: center;
      }

      .content h1 {
        font-size: 32px;
        margin-bottom: 20px;
      }

      .feature-card,
      .admin-info-card {
        background-color: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .hidden-section {
        display: none;
      }

      .toggle-sidebar-btn {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background-color: #0f83ff;
        padding: 10px;
        border-radius: 50%;
      }

      .question-paper-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      .question-paper-table th,
      .question-paper-table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
        word-wrap: break-word;
        min-width: 100px;
        vertical-align: middle;
      }

      .question-paper-table th {
        background-color: #0f83ff;
        color: white;
        position: sticky;
        top: 0;
      }

      #add-faculty-button {
        margin-top: 15px;
        background-color: #0f83ff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      }

      .input-field {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        margin: 2px 0;
        display: block;
      }

      .input-field:focus {
        border-color: #0f83ff;
        outline: none;
      }

      select.input-field {
        background-color: white;
      }

      .save-button,
      .cancel-button {
        margin: 5px;
        padding: 8px 12px;
        background-color: #0f83ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .save-button:disabled,
      .cancel-button:disabled {
        background-color: #aaa;
        cursor: not-allowed;
      }

      .logout-link {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: red;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        font-weight: bold;
      }

      .logout-link:hover {
        background-color: darkred;
      }

      .remove-button {
        background-color: red;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
      }

      .remove-button:hover {
        background-color: darkred;
      }

      #faculty-table-body {
        display: table-row-group;
      }

      #faculty-table-body tr {
        display: table-row;
      }

      #faculty-table-body td {
        display: table-cell;
        position: relative;
      }

      .input-container {
        position: relative;
        width: 100%;
        height: 100%;
      }

      .set-question-paper-button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
      }

      .set-question-paper-button:hover {
        background-color: #45a049;
      }

      .set-question-paper-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
    </style>
  </head>

  <body>
    <div class="sidebar">
      <h2>Admin Panel</h2>
      <ul>
        <li>
          <a
            href="#question-paper-assigner-content"
            onclick="showSection('question-paper-assigner-content', this)"
            >Question Paper Assigner</a
          >
        </li>
        <li>
          <a
            href="#admin-info-content"
            onclick="showSection('admin-info-content', this)"
            >Admin Info</a
          >
        </li>
      </ul>
    </div>

    <a href="#" onclick="logout()" class="logout-link">Logout</a>

    <button class="toggle-sidebar-btn" onclick="toggleSidebar()">â˜°</button>

    <div class="content-wrapper">
      <div class="content">
        <h1>Admin Dashboard</h1>

        <div
          id="question-paper-assigner-content"
          class="feature-card"
          style="margin-left: 30px"
        >
          <h3>Question Paper Assigner</h3>
          <p>
            Manage faculty assignments for question paper setting and scrutiny.
          </p>
          <table class="question-paper-table">
            <thead>
              <tr>
                <th>Serial No</th>
                <th>Faculty ID</th>
                <th>Faculty Name</th>
                <th>Subject</th>
                <th>Regulation</th>
                <th>Role</th>
                <th>Actions</th>
                <th>Response</th>
                <th>Question Paper Status</th>
              </tr>
            </thead>
            <tbody id="faculty-table-body"></tbody>
          </table>
          <button id="add-faculty-button" onclick="addRow()">
            Add New Faculty
          </button>
        </div>

        <div
          id="admin-info-content"
          class="admin-info-card hidden-section"
          style="margin-left: 30px"
        >
          <h3>Admin Info</h3>
          <p>Admin-related information goes here.</p>
        </div>
      </div>
    </div>

    <script>
      const facultyTableBody = document.getElementById("faculty-table-body");

      let refreshInterval = null;
      let isInputActive = false;

      function toggleSidebar() {
        document.querySelector(".sidebar").classList.toggle("collapsed");
        document
          .querySelector(".content-wrapper")
          .classList.toggle("collapsed");
      }

      function confirmLogout() {
        if (confirm("Do you want to logout?")) {
          window.location.href = "index.html";
        }
      }

      function showSection(sectionId, clickedLink) {
        document
          .querySelectorAll(".feature-card, .admin-info-card")
          .forEach((section) => {
            section.classList.add("hidden-section");
          });
        document.getElementById(sectionId).classList.remove("hidden-section");
        document
          .querySelectorAll(".sidebar a")
          .forEach((link) => link.classList.remove("active"));
        clickedLink.classList.add("active");
      }

      function enableSaveButton(row) {
        const inputs = row.querySelectorAll('input[required], select[required]');
        const saveButton = row.querySelector('.save-button');
        const isValid = Array.from(inputs).every(input => input.value.trim() !== '');
        saveButton.disabled = !isValid;
      }

      // Add subject mapping
      const subjects = {
        'CS8651': 'Internet Programming',
        'CS8691': 'Artificial Intelligence',
        'CS8601': 'Mobile Computing',
        'CS8602': 'Compiler Design',
        'CS8603': 'Distributed Systems'
      };

      function addRow() {
        stopPeriodicRefresh();
        isInputActive = true;
        
        // Clear any error messages or "No assignments found" message
        if (facultyTableBody.innerHTML.includes('colspan="8"')) {
            facultyTableBody.innerHTML = '';
        }
        
        const newRow = facultyTableBody.insertRow(0);
        newRow.innerHTML = `
            <td>1</td>
            <td><div class="input-container"><input class="input-field" type="text" placeholder="Faculty ID" oninput="enableSaveButton(this.closest('tr'))" required></div></td>
            <td><div class="input-container"><input class="input-field" type="text" placeholder="Faculty Name" oninput="enableSaveButton(this.closest('tr'))" required></div></td>
            <td>
                <div class="input-container">
                    <select class="input-field" onchange="enableSaveButton(this.closest('tr'))" required>
                        <option value="">Select Subject</option>
                        ${Object.entries(subjects).map(([code, name]) => 
                            `<option value="${code}">${code} - ${name}</option>`
                        ).join('')}
                    </select>
                </div>
            </td>
            <td>
                <div class="input-container">
                    <select class="input-field" onchange="enableSaveButton(this.closest('tr'))" required>
                        <option value="">Select Regulation</option>
                        <option value="R1">R1</option>
                        <option value="R2">R2</option>
                    </select>
                </div>
            </td>
            <td>
                <div class="input-container">
                    <select class="input-field" onchange="enableSaveButton(this.closest('tr'))" required>
                        <option value="">Select Role</option>
                        <option value="Paper Setter">Paper Setter</option>
                        <option value="Scrutinizer">Scrutinizer</option>
                    </select>
                </div>
            </td>
            <td>
                <button class="save-button" onclick="saveFacultyRow(this.closest('tr'))" disabled>Save</button>
                <button class="cancel-button" onclick="cancelRow(this.closest('tr'))">Cancel</button>
            </td>
            <td>Pending</td>
            <td>Yet to submit</td>
        `;
        updateRowNumbers();
      }

      function updateRowNumbers() {
        const rows = Array.from(facultyTableBody.getElementsByTagName('tr'));
        const validRows = rows.filter(row => !row.innerHTML.includes('colspan="8"'));
        validRows.forEach((row, index) => {
            const firstCell = row.cells[0];
            if (firstCell) {
                firstCell.textContent = index + 1;
            }
        });
      }

      function cancelRow(row) {
        isInputActive = false;
        row.remove();
        updateRowNumbers();
        
        // Check if table is empty and show message if needed
        if (facultyTableBody.children.length === 0) {
            facultyTableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center;">No assignments found</td>
                </tr>
            `;
        }
        
        startPeriodicRefresh();
      }

      async function checkSession() {
        try {
          const response = await fetch("/check-session", {
            credentials: "include"
          });
          const data = await response.json();
          
          if (!data.user) {
            if (data.message === "No active session") {
              window.location.href = "index.html";
            }
            return false;
          }
          return true;
        } catch (error) {
          console.error("Session check error:", error);
          return false;
        }
      }

      async function fetchAllFacultyAssignments() {
        if (isInputActive) return;

        try {
            const response = await fetch("/api/faculty-assignments", {
                credentials: "include"
            });
            
            if (!response.ok) {
                throw new Error("Failed to fetch assignments");
            }

            const data = await response.json();
            
            if (!isInputActive) {
                facultyTableBody.innerHTML = '';

                if (!data || data.length === 0) {
                    facultyTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center;">No assignments found</td>
                        </tr>
                    `;
                    return;
                }

                const sortedData = data.sort((a, b) => {
                    if (a.createdAt && b.createdAt) {
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    }
                    return 0;
                });

                sortedData.forEach((assignment, index) => {
                    const newRow = facultyTableBody.insertRow();
                    newRow.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${assignment.facultyId || 'N/A'}</td>
                        <td>${assignment.facultyName || 'N/A'}</td>
                        <td>${assignment.subjectCode} - ${assignment.subjectName || 'N/A'}</td>
                        <td>${assignment.regulation || 'N/A'}</td>
                        <td>${assignment.role || 'N/A'}</td>
                        <td>
                            <button class="remove-button" onclick="removeFaculty('${assignment.facultyId}', '${assignment.subjectCode}', '${assignment.role}', this)">Remove</button>
                        </td>
                        <td>${assignment.response === 'completed' ? 'Completed' : (assignment.response ? (assignment.response === 'yes' ? 'Accepted' : 'Declined') : 'Pending')}</td>
                        <td>${assignment.questionPaperStatus === 'submitted' ? 'Submitted' : (assignment.questionPaperStatus || 'Yet to submit')}</td>
                    `;
                });
            }
        } catch (error) {
            console.error("Fetch error:", error);
            if (!isInputActive) {
                facultyTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center;">Error loading assignments</td>
                    </tr>
                `;
            }
        }
      }

      // Function to start periodic refresh
      function startPeriodicRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        refreshInterval = setInterval(fetchAllFacultyAssignments, 30000);
      }

      // Function to stop periodic refresh
      function stopPeriodicRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
      }

      // Initialize the page
      window.onload = async function() {
        await fetchAllFacultyAssignments();
        startPeriodicRefresh();
      };

      // Cleanup on page unload
      window.onbeforeunload = function() {
        stopPeriodicRefresh();
      };

      // Function to remove faculty assignment
      async function removeFaculty(facultyId, subjectCode, role, button) {
        if (!confirm("Are you sure you want to remove this assignment?")) return;

        try {
            const response = await fetch("/remove-faculty-assignment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ facultyId, subjectCode, role })
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || "Failed to remove assignment");
            }

            alert(result.message || "Assignment removed successfully");
            await fetchAllFacultyAssignments();

        } catch (error) {
            console.error("Remove error:", error);
            alert(error.message || "Failed to remove assignment");
        }
      }

      // Function to save faculty row
      async function saveFacultyRow(row) {
        const saveButton = row.querySelector('.save-button');
        const cancelButton = row.querySelector('.cancel-button');
        saveButton.disabled = true;
        cancelButton.disabled = true;

        try {
            const subjectSelect = row.querySelector('select');
            const selectedSubject = subjectSelect.value;
            
            const data = {
                facultyId: row.querySelector('input[placeholder="Faculty ID"]').value.trim(),
                facultyName: row.querySelector('input[placeholder="Faculty Name"]').value.trim(),
                subjectCode: selectedSubject,
                subjectName: subjects[selectedSubject],
                regulation: row.querySelectorAll('select')[1].value.trim(),
                role: row.querySelectorAll('select')[2].value.trim()
            };

            const response = await fetch("/save-faculty-assignment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(data)
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || "Error saving assignment");
            }

            alert(result.message || "Faculty assignment saved successfully");
            isInputActive = false;
            await fetchAllFacultyAssignments();
            startPeriodicRefresh();

        } catch (error) {
            console.error("Save error:", error);
            alert(error.message || "Failed to save. Please try again.");
            saveButton.disabled = false;
            cancelButton.disabled = false;
        }
      }

      async function loadResponses() {
        const res = await fetch("/question-assigner-responses");
        const data = await res.json();
        const tbody = document.querySelector(".question-paper-table tbody");
        tbody.innerHTML = "";
        data.forEach((row) => {
          tbody.innerHTML += `<tr>
            <td>${row.facultyId}</td>
            <td>${row.subject}</td>
            <td>${row.response || "Pending"}</td>
            <td><button class="remove-button" onclick="removeFaculty('${
              row.facultyId
            }', this)">Remove</button></td>
        </tr>`;
        });

        window.onload = function () {
          checkPrompt();
        };
      }

      async function logout() {
        if (!confirm('Are you sure you want to logout?')) {
            return;
        }
        
        try {
            const response = await fetch('/logout', {
                method: 'POST',
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Logout failed');
            }
            
            window.location.href = '/index.html';
        } catch (error) {
            console.error('Logout error:', error);
            alert('Error during logout. Please try again.');
        }
      }

      async function redirectToSetQuestionPaper(facultyId, subjectCode) {
        try {
            const response = await fetch('/check-assignment-access', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Failed to check assignment access');
            }

            const data = await response.json();
            
            if (data.accessGranted) {
                window.location.href = `/set_question_paper.html?facultyId=${facultyId}&subjectCode=${subjectCode}`;
            } else {
                alert('You do not have permission to set question papers for this assignment.');
            }
        } catch (error) {
            console.error('Error checking assignment access:', error);
            alert('Error checking assignment access. Please try again.');
        }
      }

      console.log("Assignments received from backend:", data);
    </script>
  </body>
</html>